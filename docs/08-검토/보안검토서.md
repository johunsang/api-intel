# 보안 검토서 (Security Review Document)

| 항목 | 내용 |
|------|------|
| **프로젝트명** | API Intelligence Engine |
| **문서 버전** | v1.0 |
| **작성일** | 2026-02-25 |
| **작성자** | 조훈상 / 프로젝트 오너 |
| **승인자** | 조훈상 / 프로젝트 오너 |
| **문서 상태** | 초안 |

> **용어 규칙:** 본 문서는 [`용어규칙.md`](../01-요구사항분석/용어규칙.md)의 표기 원칙과 용어 사전을 준수한다.

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| v0.1 | 2026-02-25 | 조훈상 | 초안 작성 — OWASP Top 10 기반 보안 검토 |
| v1.0 | 2026-02-25 | 조훈상 | 보안 검토 완료 |

---

## 목차

1. [검토 개요](#1-검토-개요)
2. [기술 스택 보안 평가](#2-기술-스택-보안-평가)
3. [OWASP Top 10 대응 검토](#3-owasp-top-10-대응-검토)
4. [인증/인가 검토](#4-인증인가-검토)
5. [데이터 보호 검토](#5-데이터-보호-검토)
6. [API 보안 검토](#6-api-보안-검토)
7. [인프라/배포 보안 검토](#7-인프라배포-보안-검토)
8. [보안 체크리스트](#8-보안-체크리스트)
9. [위험 평가 요약](#9-위험-평가-요약)
10. [권고사항](#10-권고사항)
11. [관련 문서](#11-관련-문서)

---

## 1. 검토 개요

### 1.1 목적

API Intelligence Engine의 설계 및 구현 단계에서 보안 위협을 식별하고, OWASP Top 10을 기반으로 대응 방안을 정의한다.

### 1.2 범위

| 영역 | 대상 |
|------|------|
| 프론트엔드 | Next.js 16 App Router (React 19) |
| 백엔드 | Next.js API Routes / Server Actions |
| 인증 | Supabase Auth |
| 데이터베이스 | Supabase (PostgreSQL) + RLS |
| 배포 | Vercel |
| 외부 연동 | SaaS API 마켓플레이스 크롤링, LLM API |

### 1.3 위협 모델링 (STRIDE)

| 위협 유형 | 대상 | 시나리오 | 심각도 |
|----------|------|---------|--------|
| **S**poofing | Supabase Auth | 세션 탈취, OAuth 토큰 위조 | 높음 |
| **T**ampering | API 수집 데이터 | 크롤링 데이터 조작, 캐시 포이즈닝 | 중간 |
| **R**epudiation | 사용자 행동 | API 키 사용 내역 부인 | 낮음 |
| **I**nformation Disclosure | DB/API | 수집된 API 가격 정보, 사용자 데이터 유출 | 높음 |
| **D**enial of Service | 크롤러/API | 크롤링 과부하, API Rate Limit 초과 | 중간 |
| **E**levation of Privilege | RLS 정책 | RLS 우회로 타 사용자 데이터 접근 | 높음 |

---

## 2. 기술 스택 보안 평가

### 2.1 Next.js 16 (App Router)

| 항목 | 상태 | 비고 |
|------|------|------|
| Server Components 기본 사용 | 양호 | 클라이언트에 민감 로직 노출 방지 |
| Server Actions 입력 검증 | **필수** | `zod` 등으로 모든 Server Action 입력 검증 |
| `next/headers` 쿠키 관리 | 양호 | httpOnly, Secure, SameSite 설정 가능 |
| 환경변수 분리 (`NEXT_PUBLIC_` 접두사) | **주의** | 클라이언트 노출 변수와 서버 전용 변수 엄격 분리 |
| 이미지 최적화 (`next/image`) | 양호 | 외부 이미지 도메인 화이트리스트 설정 필요 |

### 2.2 Supabase

| 항목 | 상태 | 비고 |
|------|------|------|
| Row Level Security (RLS) | **필수** | 모든 테이블에 RLS 정책 활성화 |
| `anon` 키 vs `service_role` 키 | **주의** | `service_role` 키는 서버에서만 사용, 클라이언트 노출 금지 |
| Supabase Auth (JWT) | 양호 | Supabase 자체 JWT 관리 |
| 실시간 구독 권한 | **주의** | Realtime 채널에도 RLS 적용 확인 필요 |

### 2.3 Vercel

| 항목 | 상태 | 비고 |
|------|------|------|
| HTTPS 자동 적용 | 양호 | 기본 TLS 제공 |
| Environment Variables | 양호 | Preview/Production 환경 분리 |
| Edge Functions | 양호 | 지역별 실행으로 지연 최소화 |
| 빌드 로그 접근 제한 | **확인** | 팀 멤버 외 접근 차단 확인 |

---

## 3. OWASP Top 10 대응 검토

### 3.1 A01: Broken Access Control (접근 제어 실패)

**위험:** Supabase RLS 미적용 시 사용자 간 데이터 접근 가능

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| 모든 테이블 RLS 활성화 | P0 | `ALTER TABLE ... ENABLE ROW LEVEL SECURITY` |
| 사용자별 데이터 격리 정책 | P0 | `auth.uid() = user_id` 기반 RLS 정책 |
| Server Action 권한 검증 | P0 | 모든 Server Action에서 `auth.getUser()` 확인 |
| API Route 미들웨어 인증 | P0 | `middleware.ts`에서 인증 상태 검증 |
| CORS 설정 | P1 | `next.config.js`에서 허용 오리진 화이트리스트 |

### 3.2 A02: Cryptographic Failures (암호화 실패)

**위험:** 수집된 API 키, 가격 데이터 평문 저장

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| 전송 중 암호화 | 양호 | Vercel HTTPS 기본 제공 |
| 저장 시 암호화 (민감 필드) | P0 | Supabase `pgcrypto` 확장 또는 애플리케이션 레벨 AES-256-GCM |
| 환경변수 시크릿 관리 | P0 | Vercel Environment Variables, `.env.local` 미커밋 |
| 비밀번호 해싱 | 양호 | Supabase Auth 자체 bcrypt 처리 |

### 3.3 A03: Injection (인젝션)

**위험:** 크롤링 데이터 삽입 시 SQL Injection, 사용자 검색 쿼리 XSS

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| Supabase 클라이언트 파라미터 바인딩 | 양호 | `supabase.from().select()` ORM 자동 처리 |
| Server Action 입력 검증 | P0 | `zod` 스키마로 모든 입력 타입·범위 검증 |
| React 자동 XSS 방어 | 양호 | JSX 자동 이스케이프, `dangerouslySetInnerHTML` 사용 금지 |
| 크롤링 데이터 새니타이징 | P0 | 외부 데이터 저장 전 HTML 태그 제거, 입력 정규화 |

### 3.4 A04: Insecure Design (불안전한 설계)

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| Rate Limiting | P0 | Vercel Edge Middleware 또는 `upstash/ratelimit` |
| 크롤링 요청 제한 | P0 | 대상 사이트별 요청 간격·횟수 제한 (크롤링정책분석서 준수) |
| 비즈니스 로직 남용 방지 | P1 | 무료 플랜 API 호출 횟수 제한 |
| 계정 잠금 정책 | P1 | Supabase Auth 기본 제공 + 커스텀 로직 보완 |

### 3.5 A05: Security Misconfiguration (보안 설정 오류)

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| 보안 헤더 설정 | P0 | `next.config.js` headers 설정 (CSP, HSTS, X-Frame-Options 등) |
| 에러 메시지 최소화 | P0 | 프로덕션 환경에서 상세 에러 숨김, 에러 ID만 반환 |
| 디버그 모드 비활성화 | P0 | `NODE_ENV=production` 확인 |
| 불필요한 API 엔드포인트 제거 | P1 | 사용하지 않는 Route Handler 삭제 |

**Next.js 보안 헤더 설정 예시:**

```javascript
// next.config.js
const securityHeaders = [
  { key: 'X-DNS-Prefetch-Control', value: 'on' },
  { key: 'Strict-Transport-Security', value: 'max-age=63072000; includeSubDomains; preload' },
  { key: 'X-Frame-Options', value: 'DENY' },
  { key: 'X-Content-Type-Options', value: 'nosniff' },
  { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
  { key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
];
```

### 3.6 A06: Vulnerable Components (취약한 컴포넌트)

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| 의존성 보안 스캐닝 | P0 | `pnpm audit --production` CI 파이프라인 통합 |
| 자동 의존성 업데이트 | P1 | Renovate 또는 Dependabot 설정 |
| lock 파일 무결성 | P0 | `pnpm-lock.yaml` 커밋, CI에서 `pnpm install --frozen-lockfile` |

### 3.7 A07: Authentication Failures (인증 실패)

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| Supabase Auth 활용 | 양호 | 자체 인증 로직 구현 대신 Supabase Auth 사용 |
| OAuth 소셜 로그인 | P1 | Supabase Auth의 Google/GitHub OAuth 활용 |
| 세션 관리 | 양호 | Supabase JWT 자동 갱신 (`supabase.auth.onAuthStateChange`) |
| MFA 지원 | P2 | Supabase Auth MFA (TOTP) 활성화 검토 |

### 3.8 A08: Data Integrity Failures (데이터 무결성 실패)

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| CI/CD 파이프라인 보안 | P0 | GitHub Actions 최소 권한 (`permissions: contents: read`) |
| 시크릿 스캔 | P1 | `gitleaks` GitHub Action 추가 |
| SRI (Subresource Integrity) | P2 | 외부 CDN 스크립트 사용 시 integrity 해시 적용 |

### 3.9 A09: Logging Failures (로깅/모니터링 실패)

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| 보안 이벤트 로깅 | P0 | 인증 성공/실패, 인가 실패, 입력 검증 실패 기록 |
| 민감 데이터 로그 제외 | P0 | 비밀번호, 토큰, API 키 로그 마스킹 (redact) |
| 구조화 로깅 | P1 | `pino` 또는 Vercel Log Drain 활용 |
| 모니터링 대시보드 | P2 | Vercel Analytics + 커스텀 보안 이벤트 대시보드 |

**로깅 필수/금지 항목:**

| 반드시 로깅 | 절대 로그 금지 |
|-------------|---------------|
| 인증 성공/실패 | 비밀번호 (평문/해시) |
| 인가 실패 (403) | API 키/시크릿 |
| 입력 검증 실패 | JWT/세션 토큰 |
| 관리자 작업 | 신용카드 번호 |
| 데이터 수정/삭제 | 개인 식별 정보 (주민번호 등) |
| 비정상 요청 패턴 | Supabase service_role 키 |

### 3.10 A10: SSRF (서버사이드 요청 위조)

**위험:** 크롤러가 사용자 입력 URL을 직접 요청할 경우 내부 네트워크 접근 가능

**대응 방안:**

| 조치 | 우선순위 | 구현 방법 |
|------|----------|-----------|
| 크롤링 대상 URL 화이트리스트 | P0 | 허용된 API 마켓플레이스 도메인만 크롤링 |
| 내부 IP 대역 차단 | P0 | `10.x`, `172.16.x`, `192.168.x`, `127.x` 대역 요청 차단 |
| DNS Rebinding 방지 | P1 | URL 파싱 후 DNS 확인 → IP 검증 → 요청 순서 적용 |
| 리다이렉트 제한 | P1 | `redirect: 'error'` 또는 최대 리다이렉트 횟수 제한 |

---

## 4. 인증/인가 검토

### 4.1 Supabase Auth 보안 설정

| 설정 | 권장값 | 비고 |
|------|--------|------|
| JWT 만료 시간 | 3600초 (1시간) | Supabase 대시보드에서 설정 |
| Refresh Token 회전 | 활성화 | 토큰 재사용 공격 방지 |
| 이메일 확인 필수 | 활성화 | 가입 시 이메일 인증 |
| 비밀번호 최소 길이 | 8자 이상 | Supabase Auth 기본값 확인 |
| Rate Limiting | 활성화 | Supabase 기본 Rate Limit 적용 |

### 4.2 RLS 정책 검토

| 테이블 | 정책 | 검증 포인트 |
|--------|------|------------|
| `users` | `auth.uid() = id` | 자기 자신만 읽기/수정 |
| `api_collections` | `auth.uid() = user_id` | 소유자만 CRUD |
| `api_analyses` | `auth.uid() = user_id` | 분석 결과 소유자만 접근 |
| `subscriptions` | `auth.uid() = user_id` | 구독 정보 소유자만 접근 |
| 공개 데이터 테이블 | `true` (SELECT only) | 읽기만 허용, 수정 불가 |

### 4.3 미들웨어 인증 플로우

```
요청 → middleware.ts → Supabase 세션 확인 → 인증됨? → 계속
                                           → 미인증? → /login 리다이렉트
```

---

## 5. 데이터 보호 검토

### 5.1 데이터 분류

| 분류 | 예시 | 보호 수준 |
|------|------|----------|
| 공개 | API 카탈로그 기본 정보 | 낮음 |
| 내부 | 수집된 API 가격·트렌드 데이터 | 중간 |
| 기밀 | 사용자 계정, 이메일, 구독 정보 | 높음 |
| 극비 | Supabase service_role 키, LLM API 키 | 최고 |

### 5.2 데이터 보호 조치

| 데이터 | 전송 중 | 저장 시 | 접근 제어 |
|--------|---------|---------|----------|
| 사용자 인증 정보 | HTTPS (TLS 1.3) | Supabase Auth 자동 해싱 | Supabase Auth |
| API 수집 데이터 | HTTPS | PostgreSQL 기본 저장 | RLS 정책 |
| 환경변수/시크릿 | — | Vercel Encrypted | 배포 환경 분리 |
| LLM API 키 | HTTPS | Vercel Environment Variables | 서버 전용 변수 |

---

## 6. API 보안 검토

### 6.1 API Route 보안

| 항목 | 대응 방안 | 우선순위 |
|------|-----------|----------|
| 인증 필수 | 모든 API Route에 Supabase Auth 검증 | P0 |
| 입력 검증 | `zod` 스키마로 요청 바디/파라미터 검증 | P0 |
| Rate Limiting | IP 및 사용자별 요청 제한 | P0 |
| 응답 데이터 최소화 | 필요한 필드만 반환, `select()` 명시 | P1 |
| API 버전 관리 | `/api/v1/` 경로 구조 | P2 |

### 6.2 크롤링 보안

| 항목 | 대응 방안 | 우선순위 |
|------|-----------|----------|
| robots.txt 준수 | 대상 사이트 크롤링 정책 확인 | P0 |
| 요청 간격 제한 | 최소 1초 이상 간격, 대상별 커스텀 | P0 |
| User-Agent 명시 | 프로젝트명 포함 User-Agent 설정 | P0 |
| 수집 데이터 검증 | 외부 데이터 새니타이징 후 저장 | P0 |
| 오류 시 백오프 | 429/5xx 응답 시 지수 백오프 적용 | P1 |

---

## 7. 인프라/배포 보안 검토

### 7.1 Vercel 배포 보안

| 항목 | 상태 | 비고 |
|------|------|------|
| HTTPS 강제 | 양호 | Vercel 기본 제공 |
| Preview 배포 접근 제한 | **확인** | Vercel Authentication 또는 Password Protection |
| 환경변수 암호화 | 양호 | Vercel 자동 암호화 |
| 빌드 캐시 보안 | 양호 | 빌드 간 캐시 격리 |

### 7.2 GitHub 저장소 보안

| 항목 | 대응 방안 | 우선순위 |
|------|-----------|----------|
| `.env` 파일 미커밋 | `.gitignore`에 등록 확인 | P0 |
| 브랜치 보호 규칙 | `main` 브랜치 PR 필수, 리뷰 필수 | P1 |
| 시크릿 스캔 | GitHub Secret Scanning 또는 `gitleaks` | P1 |
| 의존성 알림 | Dependabot 또는 Renovate 활성화 | P1 |

---

## 8. 보안 체크리스트

### 8.1 개발 단계

- [ ] 모든 Server Action에 `zod` 입력 검증 적용
- [ ] 환경변수 `NEXT_PUBLIC_` 접두사 분리 확인
- [ ] `dangerouslySetInnerHTML` 사용 금지 확인
- [ ] 크롤링 데이터 새니타이징 로직 구현
- [ ] Supabase `service_role` 키 서버 전용 확인
- [ ] 에러 핸들러 민감 정보 미노출 확인

### 8.2 배포 단계

- [ ] 모든 Supabase 테이블 RLS 활성화
- [ ] `next.config.js` 보안 헤더 설정
- [ ] `.env` 파일 `.gitignore` 등록
- [ ] Vercel 환경변수 Production/Preview 분리
- [ ] `pnpm audit` 취약점 0건 확인
- [ ] CI/CD 파이프라인 시크릿 스캔 통합

### 8.3 운영 단계

- [ ] 보안 이벤트 로깅 동작 확인
- [ ] Rate Limiting 동작 확인
- [ ] Supabase Auth 설정 검토 (JWT 만료, Refresh Token 회전)
- [ ] 의존성 자동 업데이트 설정
- [ ] 정기 보안 점검 일정 수립 (월 1회)

---

## 9. 위험 평가 요약

| 위험 항목 | 심각도 | 발생 가능성 | 현재 상태 | 대응 우선순위 |
|----------|--------|------------|----------|-------------|
| RLS 미적용으로 인한 데이터 유출 | 높음 | 높음 | 미구현 | P0 |
| Server Action 입력 검증 누락 | 높음 | 중간 | 미구현 | P0 |
| 보안 헤더 미설정 | 중간 | 높음 | 미구현 | P0 |
| Rate Limiting 미적용 | 중간 | 중간 | 미구현 | P0 |
| 크롤링 SSRF | 높음 | 낮음 | 미구현 | P0 |
| 민감 데이터 로깅 | 중간 | 중간 | 미구현 | P0 |
| `service_role` 키 클라이언트 노출 | 높음 | 낮음 | 미확인 | P0 |
| 의존성 취약점 | 중간 | 중간 | 미구현 | P1 |
| MFA 미지원 | 낮음 | 낮음 | 미구현 | P2 |

---

## 10. 권고사항

### 10.1 즉시 조치 (P0)

1. **Supabase RLS 전면 적용** — 모든 테이블에 `auth.uid()` 기반 정책 설정
2. **Server Action 입력 검증** — `zod` 스키마 필수 적용
3. **보안 헤더 설정** — `next.config.js`에 CSP, HSTS, X-Frame-Options 등 설정
4. **Rate Limiting 구현** — `@upstash/ratelimit` 또는 Vercel Edge Middleware 활용
5. **크롤링 URL 화이트리스트** — 허용된 도메인만 크롤링, 내부 IP 대역 차단
6. **환경변수 분리 확인** — `NEXT_PUBLIC_` 접두사 없는 시크릿이 클라이언트에 노출되지 않는지 확인

### 10.2 단기 조치 (P1)

1. **CI/CD 보안 통합** — `pnpm audit`, `gitleaks`, `semgrep` 파이프라인 추가
2. **의존성 자동 업데이트** — Renovate 또는 Dependabot 설정
3. **구조화 로깅** — `pino` 기반 보안 이벤트 로깅 + 민감 데이터 마스킹
4. **GitHub 브랜치 보호** — `main` PR 필수 + 리뷰 필수 설정

### 10.3 중기 조치 (P2)

1. **MFA 활성화** — Supabase Auth TOTP MFA 검토
2. **보안 모니터링 대시보드** — Vercel Analytics + 커스텀 보안 이벤트 추적
3. **정기 침투 테스트** — 분기별 보안 점검 수행

---

## 11. 관련 문서

| 문서 | 관계 |
|------|------|
| [시스템아키텍처설계서 (SAD)](../02-시스템설계/시스템아키텍처설계서-SAD.md) | 아키텍처 보안 설계 참조 |
| [데이터베이스설계서](../02-시스템설계/데이터베이스설계서.md) | RLS 정책, 데이터 분류 참조 |
| [API설계서](../02-시스템설계/API설계서.md) | API 인증/인가, Rate Limiting 참조 |
| [크롤링정책분석서](../01-요구사항분석/크롤링정책분석서.md) | 크롤링 보안 정책 참조 |
| [배포문서](../06-배포/배포문서.md) | Vercel 배포 보안 설정 참조 |
| [비기능상세설계서](../03-상세설계/비기능상세설계서.md) | 보안 비기능 요구사항 참조 |
| [변경이력서](../07-유지보수/변경이력서.md) | 보안 관련 변경 이력 추적 |
